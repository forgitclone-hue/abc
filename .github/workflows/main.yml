name: WhatsApp Bot - PM2 Runtime 5h Cycle

on:
  # Every 5 hours (at :00)
  schedule:
    - cron: '0 */5 * * *'

  # You can manually start it anytime from Actions tab
  workflow_dispatch:

# ── Very important ── Prevents multiple bot instances running at once
concurrency:
  group: whatsapp-bot-pm2
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 320          # 5h + 20min buffer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Start WhatsApp Bot (PM2 Runtime)
        run: |
          echo "═══════════════════════════════════════════════"
          echo "   WhatsApp Bot starting   $(date '+%Y-%m-%d %H:%M:%S')"
          echo "   Schedule: every 5 hours"
          echo "   Using:    npx pm2-runtime start start.js"
          echo "═══════════════════════════════════════════════"
          echo ""

          # The exact command you requested
          npx pm2-runtime start start.js --name "whatsapp-bot"

          # Optional: more stable flags (uncomment if bot dies too often)
          # npx pm2-runtime start start.js --name "whatsapp-bot" \
          #   --deep-monitoring \
          #   --exp-backoff-restart-delay=100
